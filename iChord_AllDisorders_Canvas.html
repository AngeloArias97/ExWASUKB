<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chord Canvas</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="chord_data.js"></script>
  <style>
    body { margin: 0; position: relative; font-family: sans-serif; }

    #zoom-controls { text-align: left; margin: 8px 0; }
    #zoom-controls button { margin: 0 2px; }

    #layout {
      display: flex;
      align-items: flex-start;
    }

    canvas { display: block; background:white; }

    #legend {
      width: 260px;
      padding: 10px 20px 10px 10px;
      box-sizing: border-box;
    }

    #legend-title, #domain-legend-title {
      margin: 0 0 8px 0;
      font-size: 16px;
      cursor: pointer;
      user-select: none;
    }

    #legend-items.collapsed,
    #domain-legend-items.collapsed {
      display: none;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      cursor: pointer;
      user-select: none;
      font-size: 14px;
    }

    .legend-swatch {
      width: 14px;
      height: 14px;
      margin-right: 6px;
      border-radius: 2px;
      border: 1px solid rgba(0,0,0,0.2);
    }

    .legend-item.active .legend-swatch {
      outline: 2px solid #000;
      outline-offset: 1px;
    }

    #tooltip {
      position: absolute;
      line-height: 1;
      padding: 12px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      border-radius: 2px;
      pointer-events: none;
      display: none;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div id="zoom-controls">
    <button id="zoom-in">+ Zoom</button>
    <button id="zoom-out">- Zoom</button>
    <button id="zoom-reset">Reset</button>
  </div>

  <div id="layout">
    <canvas id="chordCanvas"></canvas>
    <div id="legend">
      <h3 id="legend-title">Groups of exposures ▾</h3>
      <div id="legend-items"></div>

      <h3 id="domain-legend-title" style="margin-top:16px;">Diagnostic domains ▾</h3>
      <div id="domain-legend-items"></div>
    </div>
  </div>

  <div id="tooltip"></div>

  <script>
  (function(){
    var data = chordData.x;
    var matrix = data.matrix;
    var options = data.options;

    var canvas = document.getElementById('chordCanvas');
    var legendTitle = document.getElementById('legend-title');
    var legendItemsContainer = document.getElementById('legend-items');
    var domainLegendTitle = document.getElementById('domain-legend-title');
    var domainLegendItemsContainer = document.getElementById('domain-legend-items');
    var tooltip = document.getElementById('tooltip');
    var context = canvas.getContext('2d');

    var legendWidth = 260;
    var width = window.innerWidth - legendWidth;
    var height = window.innerHeight - 80;
    canvas.width = width;
    canvas.height = height;

    var margin = options.margin * 0.3;
    var outerRadius = Math.min(width, height) / 2 - margin;
    var innerRadius = outerRadius * (1 - options.groupThickness);

    var chordLayout = d3.chord()
        .padAngle(options.groupPadding)
        .sortSubgroups(d3.descending)(matrix);

    var color = d3.scaleOrdinal()
        .domain(d3.range(matrix.length))
        .range(options.groupColors);

    var arcGen = d3.arc()
        .innerRadius(innerRadius)
        .outerRadius(outerRadius)
        .context(null);

    var ribbonGen = d3.ribbon()
        .radius(innerRadius)
        .context(null);

    var groups = chordLayout.groups.map(function(g){
      return { data: g, path: new Path2D(arcGen(g)), color: color(g.index) };
    });

    var chords = chordLayout.map(function(d){
      return { data: d, path: new Path2D(ribbonGen(d)), color: color(d.target.index) };
    });

    var transform = { x: 0, y: 0, k: 1 };
    var selectedGroup = null;
    var selectedChord = null;
    var selectedExposureColor = null;
    var selectedDomain = null;
    var hoveredGroup = null;
    var hoveredChord = null;

    var isDragging = false;
    var lastMousePos = null;
    var legendCollapsed = false;
    var domainLegendCollapsed = false;

    var exposureLegendItems = [
      { label: 'Traumatic events',          color: '#FF67A4' },
      { label: 'Substance use',            color: '#FD61D1' },
      { label: 'Sociodemographics',        color: '#E76BF3' },
      { label: 'Psychosocial factors',     color: '#B983FF' },
      { label: 'Physical measures',        color: '#00B0F6' },
      { label: 'Operations',               color: '#00BCD8' },
      { label: 'Local environment',        color: '#00BF7D' },
      { label: 'Lifestyle and environment',color: '#00BA38' },
      { label: 'Health and medical history',color:'#6BB100' },
      { label: 'Early life factors',       color: '#A3A500' },
      { label: 'Digestive health',         color: '#C99800' },
      { label: 'Diet by 24-hour recall',   color: '#E58700' },
      { label: 'Biological samples',       color: '#F8766D' }
    ];

    var diagnosticLegendItems = [
      { key: 'anxiety',   label: 'Anxiety disorders', groupIndices: [0] },
      { key: 'depressive', label: 'Depressive disorders',      groupIndices: [1] },
      { key: 'eating', label: 'Eating disorders',        groupIndices: [2] },
      { key: 'bipolar', label: 'Bipolar manic disorders',    groupIndices: [3] },
      { key: 'psychotic', label: 'Psychotic disorders',              groupIndices: [4] },
      { key: 'personality', label: 'Personality disorders',            groupIndices: [5] },
      { key: 'neurodevelopmental', label: 'Neurodevelopmental disorders',            groupIndices: [6] }
    ];

    exposureLegendItems.forEach(function(item){
      var row = document.createElement('div');
      row.className = 'legend-item';
      var swatch = document.createElement('span');
      swatch.className = 'legend-swatch';
      swatch.style.backgroundColor = item.color;
      var label = document.createElement('span');
      label.textContent = item.label;
      row.appendChild(swatch);
      row.appendChild(label);
      row.addEventListener('click', function(){
        if (selectedExposureColor === item.color) {
          selectedExposureColor = null;
        } else {
          selectedExposureColor = item.color;
          selectedGroup = null;
          selectedChord = null;
        }
        hoveredGroup = null;
        hoveredChord = null;
        tooltip.style.display = 'none';
        updateExposureLegendActive();
        draw();
      });
      legendItemsContainer.appendChild(row);
      item._element = row;
    });

    diagnosticLegendItems.forEach(function(item){
      var row = document.createElement('div');
      row.className = 'legend-item';
      var swatch = document.createElement('span');
      swatch.className = 'legend-swatch';
      swatch.style.backgroundColor = '#CCCCCC';
      var label = document.createElement('span');
      label.textContent = item.label;
      row.appendChild(swatch);
      row.appendChild(label);
      row.addEventListener('click', function(){
        if (selectedDomain && selectedDomain.key === item.key) {
          selectedDomain = null;
        } else {
          selectedDomain = item;
          selectedGroup = null;
          selectedChord = null;
        }
        hoveredGroup = null;
        hoveredChord = null;
        tooltip.style.display = 'none';
        updateDomainLegendActive();
        draw();
      });
      domainLegendItemsContainer.appendChild(row);
      item._element = row;
    });

    function updateExposureLegendActive(){
      exposureLegendItems.forEach(function(item){
        if (item._element) {
          if (item.color === selectedExposureColor) {
            item._element.classList.add('active');
          } else {
            item._element.classList.remove('active');
          }
        }
      });
    }

    function updateDomainLegendActive(){
      diagnosticLegendItems.forEach(function(item){
        if (item._element) {
          if (selectedDomain && item.key === selectedDomain.key) {
            item._element.classList.add('active');
          } else {
            item._element.classList.remove('active');
          }
        }
      });
    }

    function updateLegendCollapsed(){
      if (legendCollapsed) {
        legendItemsContainer.classList.add('collapsed');
        legendTitle.textContent = 'Groups of exposures ▸';
      } else {
        legendItemsContainer.classList.remove('collapsed');
        legendTitle.textContent = 'Groups of exposures ▾';
      }
    }

    function updateDomainLegendCollapsed(){
      if (domainLegendCollapsed) {
        domainLegendItemsContainer.classList.add('collapsed');
        domainLegendTitle.textContent = 'Diagnostic domains ▸';
      } else {
        domainLegendItemsContainer.classList.remove('collapsed');
        domainLegendTitle.textContent = 'Diagnostic domains ▾';
      }
    }

    legendTitle.addEventListener('click', function(){
      legendCollapsed = !legendCollapsed;
      updateLegendCollapsed();
    });
    domainLegendTitle.addEventListener('click', function(){
      domainLegendCollapsed = !domainLegendCollapsed;
      updateDomainLegendCollapsed();
    });
    updateLegendCollapsed();
    updateDomainLegendCollapsed();

    d3.select('#zoom-in').on('click', function(){
      transform.k *= 1.2;
      draw();
    });

    d3.select('#zoom-out').on('click', function(){
      transform.k /= 1.2;
      draw();
    });

    d3.select('#zoom-reset').on('click', function(){
      transform = { x: 0, y: 0, k: 1 };
      selectedGroup = null;
      selectedChord = null;
      selectedExposureColor = null;
      selectedDomain = null;
      hoveredGroup = null;
      hoveredChord = null;
      tooltip.style.display = 'none';
      updateExposureLegendActive();
      updateDomainLegendActive();
      draw();
    });

    canvas.addEventListener('dblclick', function(){
      transform = { x: 0, y: 0, k: 1 };
      selectedGroup = null;
      selectedChord = null;
      selectedExposureColor = null;
      selectedDomain = null;
      hoveredGroup = null;
      hoveredChord = null;
      tooltip.style.display = 'none';
      updateExposureLegendActive();
      updateDomainLegendActive();
      draw();
    });

    canvas.addEventListener('mousedown', function(event){
      isDragging = true;
      lastMousePos = { x: event.clientX, y: event.clientY };
      tooltip.style.display = 'none';
    });

    window.addEventListener('mouseup', function(){
      isDragging = false;
      lastMousePos = null;
    });

    canvas.addEventListener('mousemove', onMove);
    canvas.addEventListener('mouseout', function(){
      hoveredGroup = null; hoveredChord = null; tooltip.style.display = 'none'; draw();
    });
    canvas.addEventListener('click', onClick);

    function getPointer(event){
      var p = d3.pointer(event, canvas);
      var x = (p[0] - width/2 - transform.x) / transform.k;
      var y = (p[1] - height/2 - transform.y) / transform.k;
      return [x, y];
    }

    function selectedDomainIndices(){
      if (!selectedDomain) return null;
      return selectedDomain.groupIndices || [];
    }

    function chordMatchesExposure(c){
      if (!selectedExposureColor) return true;
      return c.color === selectedExposureColor;
    }

    function chordMatchesDomain(c){
      var inds = selectedDomainIndices();
      if (!inds) return true;
      return inds.indexOf(c.data.source.index) !== -1 || inds.indexOf(c.data.target.index) !== -1;
    }

    function groupMatchesExposure(g){
      if (!selectedExposureColor) return true;
      return g.color === selectedExposureColor;
    }

    function groupMatchesDomain(g){
      var inds = selectedDomainIndices();
      if (!inds) return true;
      return inds.indexOf(g.data.index) !== -1;
    }

    function shouldFadeChord(c, id){
      if (selectedChord !== null) {
        return id !== selectedChord;
      }
      if (selectedGroup !== null) {
        return c.data.source.index !== selectedGroup && c.data.target.index !== selectedGroup;
      }
      if (selectedExposureColor || selectedDomain) {
        if (!chordMatchesExposure(c)) return true;
        if (!chordMatchesDomain(c)) return true;
      }
      if (hoveredChord) {
        return hoveredChord !== c;
      }
      if (hoveredGroup !== null) {
        return c.data.source.index !== hoveredGroup && c.data.target.index !== hoveredGroup;
      }
      return false;
    }

    function shouldFadeGroup(g){
      if (selectedGroup !== null) {
        return g.data.index !== selectedGroup;
      }
      if (selectedChord !== null) {
        var parts = selectedChord.split('-');
        var i0 = +parts[0], i1 = +parts[1];
        return g.data.index !== i0 && g.data.index !== i1;
      }
      if (selectedExposureColor || selectedDomain) {
        var matchExp = groupMatchesExposure(g);
        var matchDom = groupMatchesDomain(g);
        if (!matchExp && !matchDom) return true;
      }
      if (hoveredGroup !== null) {
        return g.data.index !== hoveredGroup;
      }
      return false;
    }

    function onMove(event){
      if (isDragging && lastMousePos) {
        var dx = event.clientX - lastMousePos.x;
        var dy = event.clientY - lastMousePos.y;
        transform.x += dx;
        transform.y += dy;
        lastMousePos = { x: event.clientX, y: event.clientY };
        draw();
        return;
      }

      var pos = getPointer(event);

      hoveredChord = null;
      hoveredGroup = null;

      for(var i=0;i<chords.length;i++){
        if(context.isPointInPath(chords[i].path, pos[0], pos[1])){
          hoveredChord = chords[i];
          break;
        }
      }
      if (hoveredChord) {
        var hid = hoveredChord.data.source.index + '-' + hoveredChord.data.target.index;
        if (shouldFadeChord(hoveredChord, hid)) {
          hoveredChord = null;
        }
      }
      if(!hoveredChord){
        for(var gIdx=0;gIdx<groups.length;gIdx++){
          if(context.isPointInPath(groups[gIdx].path, pos[0], pos[1])){
            hoveredGroup = groups[gIdx].data.index;
            if (shouldFadeGroup(groups[gIdx])) {
              hoveredGroup = null;
            }
            if (hoveredGroup !== null) break;
          }
        }
      }

      if(hoveredChord){
        tooltip.innerHTML = chordTooltip(hoveredChord.data);
        tooltip.style.display = 'block';
        tooltip.style.left = (event.clientX + 10) + 'px';
        tooltip.style.top = (event.clientY + 10) + 'px';
      } else if(hoveredGroup !== null){
        tooltip.innerHTML = groupTooltip(groups[hoveredGroup].data);
        tooltip.style.display = 'block';
        tooltip.style.left = (event.clientX + 10) + 'px';
        tooltip.style.top = (event.clientY + 10) + 'px';
      } else {
        tooltip.style.display = 'none';
      }
      draw();
    }

    function onClick(event){
      var pos = getPointer(event);
      var clicked = false;

      for(var i=0;i<chords.length;i++){
        if(context.isPointInPath(chords[i].path, pos[0], pos[1])){
          var id = chords[i].data.source.index + '-' + chords[i].data.target.index;
          if(shouldFadeChord(chords[i], id)){
            continue;
          }
          if(selectedChord === id){
            selectedChord = null;
          } else {
            selectedChord = id;
            selectedGroup = null;
            selectedExposureColor = null;
            selectedDomain = null;
            updateExposureLegendActive();
            updateDomainLegendActive();
          }
          clicked = true;
          break;
        }
      }

      if(!clicked){
        for(var j=0;j<groups.length;j++){
          if(context.isPointInPath(groups[j].path, pos[0], pos[1])){
            if(shouldFadeGroup(groups[j])) continue;
            if(selectedGroup === groups[j].data.index){
              selectedGroup = null;
            } else {
              selectedGroup = groups[j].data.index;
              selectedChord = null;
              selectedExposureColor = null;
              selectedDomain = null;
              updateExposureLegendActive();
              updateDomainLegendActive();
            }
            clicked = true;
            break;
          }
        }
      }

      if(!clicked){
        selectedGroup = null;
        selectedChord = null;
        tooltip.style.display = 'none';
      }

      draw();
    }

    function sigFigs(n, sig){
      if(n == 0) return n;
      if(sig == null) sig = 7;
      var mult = Math.pow(10, sig - Math.floor(Math.log(n) / Math.LN10) - 1);
      return Math.round(n * mult) / mult;
    }

    function groupTooltip(d){
      return options.tooltipNames[d.index];
    }

    function chordTooltip(d){
      var i = d.source.index, j = d.target.index;
      var vij = sigFigs(matrix[i][j], options.precision);
      var vji = sigFigs(matrix[j][i], options.precision);
      var dir1 = options.tooltipNames[i] + options.tooltipGroupConnector +
                 options.tooltipNames[j] + ': ' + vij + options.tooltipUnit;
      var dir2 = options.tooltipNames[j] + options.tooltipGroupConnector +
                 options.tooltipNames[i] + ': ' + vji + options.tooltipUnit;
      if(options.type === 'directional'){
        if(i === j){
          return dir1;
        } else {
          if(options.showZeroTooltips){
            return dir1 + '<br>' + dir2;
          } else {
            return dir1 + (vji > 0 ? '<br>' + dir2 : '');
          }
        }
      } else if(options.type === 'bipartite'){
        return dir2;
      }
      return '';
    }

    function draw(){
      context.save();
      context.clearRect(0, 0, width, height);
      context.translate(width/2 + transform.x, height/2 + transform.y);
      context.scale(transform.k, transform.k);

      groups.forEach(function(g){
        var fade = shouldFadeGroup(g);
        context.beginPath();
        context.fillStyle = g.color;
        context.strokeStyle = options.groupedgeColor || g.color;
        context.globalAlpha = fade ? options.fadeLevel : 1;
        context.fill(g.path);
        context.stroke(g.path);
        context.globalAlpha = 1;
      });

      chords.forEach(function(c){
        var id = c.data.source.index + '-' + c.data.target.index;
        var fade = shouldFadeChord(c, id);
        context.beginPath();
        context.fillStyle = c.color;
        var baseOpacity = options.chordOpacity || 0.75;
        context.globalAlpha = fade ? options.fadeLevel : baseOpacity;
        context.fill(c.path);
        context.globalAlpha = 1;
      });

      context.restore();
    }

    draw();
  })();
  </script>
</body>
</html>
